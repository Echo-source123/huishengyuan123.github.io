<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¾…åŠäº‹é¡¹ç®¡ç†ç³»ç»Ÿï¼ˆæœ€ç»ˆç‰ˆï¼‰</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Microsoft Yahei", Arial, sans-serif;
    }
    body {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f7fa;
    }
    /* ç™»å½•é¡µé¢æ ·å¼ */
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.1);
    }
    .login-title {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 30px;
      font-size: 22px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      color: #34495e;
      font-weight: 600;
      font-size: 14px;
    }
    input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    input:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
    }
    .btn {
      width: 100%;
      padding: 12px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .btn:hover {
      background-color: #2980b9;
    }
    .login-tip {
      text-align: center;
      margin-top: 15px;
      font-size: 13px;
      color: #7f8c8d;
    }
    .error-msg {
      color: #e74c3c;
      font-size: 13px;
      margin-top: 5px;
      display: none;
    }
    /* ä¸»é¡µé¢æ ·å¼ */
    .main-container {
      display: none;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    .header-title {
      color: #2c3e50;
      font-size: 24px;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .admin-btn {
      padding: 6px 12px;
      background-color: #9b59b6;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
    }
    .admin-btn:hover {
      background-color: #8e44ad;
    }
    .logout-btn {
      padding: 6px 12px;
      background-color: #e74c3c;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
    }
    .logout-btn:hover {
      background-color: #c0392b;
    }
    /* åŠŸèƒ½åˆ‡æ¢æ ‡ç­¾ */
    .tab-container {
      display: flex;
      margin-bottom: 20px;
      border-radius: 8px;
      overflow: hidden;
      background-color: #eee;
    }
    .tab-btn {
      flex: 1;
      padding: 12px;
      text-align: center;
      border: none;
      background-color: #eee;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .tab-btn.active {
      background-color: #3498db;
      color: white;
    }
    .tab-btn:not(.active):hover {
      background-color: #ddd;
    }
    /* é€šç”¨å¡ç‰‡æ ·å¼ */
    .card {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      display: none;
    }
    .card.active {
      display: block;
    }
    .card-title {
      color: #2c3e50;
      margin-bottom: 25px;
      font-size: 18px;
      border-bottom: 1px solid #eee;
      padding-bottom: 15px;
    }
    /* åˆ›å»ºå¾…åŠè¡¨å•æ ·å¼ */
    textarea {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      min-height: 120px;
      resize: vertical;
      transition: border-color 0.3s;
    }
    textarea:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
    }
    /* æˆ‘çš„å¾…åŠåˆ—è¡¨æ ·å¼ */
    .filter-btn-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .filter-btn {
      padding: 8px 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: white;
      cursor: pointer;
      transition: all 0.3s;
    }
    .filter-btn.active {
      background-color: #3498db;
      color: white;
      border-color: #3498db;
    }
    .todo-item {
      padding: 20px;
      border-bottom: 1px solid #eee;
      margin-bottom: 15px;
      border-radius: 6px;
      background-color: #fefefe;
      cursor: pointer;
      transition: box-shadow 0.3s;
    }
    .todo-item:hover {
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .todo-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .todo-title {
      font-size: 18px;
      font-weight: 600;
      color: #2c3e50;
    }
    .todo-status {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-pending {
      background-color: #ffeaa7;
      color: #e67e22;
    }
    .status-completed {
      background-color: #a5d6a7;
      color: #2e7d32;
    }
    .todo-meta {
      color: #7f8c8d;
      font-size: 13px;
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    .todo-brief {
      color: #34495e;
      line-height: 1.6;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .message {
      text-align: center;
      padding: 10px;
      margin-top: 15px;
      border-radius: 6px;
      font-size: 14px;
      display: none;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      display: block;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
      display: block;
    }
    .empty-tip {
      text-align: center;
      color: #7f8c8d;
      padding: 30px 0;
      font-size: 14px;
    }
    /* æé†’å¼¹çª—æ ·å¼ */
    .reminder-modal {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 300px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 15px;
      z-index: 9999;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .reminder-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
    }
    .reminder-title {
      font-weight: 600;
      color: #e67e22;
    }
    .reminder-close {
      cursor: pointer;
      font-size: 18px;
      color: #7f8c8d;
    }
    .reminder-content {
      font-size: 14px;
      line-height: 1.5;
      color: #34495e;
    }
    /* å‚¬åŠå¼¹çª—æ ·å¼ï¼ˆéœ€ç¡®è®¤ï¼‰ */
    .remind-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 400px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 30px rgba(0,0,0,0.2);
      padding: 30px;
      z-index: 10002;
      border: 2px solid #e74c3c;
    }
    .remind-header {
      font-size: 18px;
      font-weight: 600;
      color: #e74c3c;
      margin-bottom: 15px;
      text-align: center;
    }
    .remind-content {
      font-size: 14px;
      line-height: 1.6;
      color: #34495e;
      margin-bottom: 20px;
    }
    .remind-confirm {
      width: 100%;
      padding: 10px;
      background-color: #e74c3c;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    .remind-confirm:hover {
      background-color: #c0392b;
    }
    /* ç®¡ç†å‘˜å¼¹çª—æ ·å¼ */
    .admin-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    .admin-modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      width: 400px;
      max-width: 90%;
    }
    .admin-modal-title {
      font-size: 20px;
      color: #2c3e50;
      margin-bottom: 20px;
      text-align: center;
    }
    .close-modal {
      float: right;
      font-size: 20px;
      cursor: pointer;
      color: #7f8c8d;
    }
    .user-list {
      max-height: 200px;
      overflow-y: auto;
      margin: 20px 0;
      border: 1px solid #eee;
      border-radius: 6px;
    }
    .user-item {
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #f5f5f5;
    }
    .user-item:last-child {
      border-bottom: none;
    }
    .user-role {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      color: white;
    }
    .role-admin {
      background-color: #9b59b6;
    }
    .role-user {
      background-color: #3498db;
    }
    /* å¾…åŠè¯¦æƒ…å¼¹çª—æ ·å¼ */
    .todo-detail-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10001;
      padding: 20px;
    }
    .todo-detail-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      width: 600px;
      max-width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid #eee;
      padding-bottom: 15px;
    }
    .detail-title {
      font-size: 20px;
      color: #2c3e50;
      font-weight: 600;
    }
    .detail-close {
      font-size: 20px;
      cursor: pointer;
      color: #7f8c8d;
    }
    .detail-meta {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 6px;
    }
    .meta-item {
      margin-bottom: 8px;
      font-size: 14px;
      color: #34495e;
    }
    .meta-label {
      font-weight: 600;
      color: #2c3e50;
      margin-right: 5px;
    }
    .detail-content {
      margin-bottom: 20px;
    }
    .content-label {
      font-weight: 600;
      margin-bottom: 10px;
      display: block;
      color: #2c3e50;
    }
    .edit-content {
      width: 100%;
      min-height: 150px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    /* å›¾ç‰‡ä¸Šä¼ æ ·å¼ */
    .upload-section {
      margin-bottom: 20px;
    }
    .upload-btn {
      display: inline-block;
      padding: 8px 15px;
      background-color: #3498db;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    #imageUpload {
      display: none;
    }
    .preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    .image-preview-wrapper {
      position: relative;
      width: 100px;
      height: 100px;
    }
    .image-preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    .delete-img-btn {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: #e74c3c;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0;
    }
    .delete-img-btn:hover {
      background-color: #c0392b;
    }
    /* è¯¦æƒ…é¡µæ“ä½œæŒ‰é’®ç»„ */
    .detail-action {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .save-btn {
      padding: 8px 20px;
      background-color: #27ae60;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .save-btn:hover {
      background-color: #219653;
    }
    .complete-btn-detail {
      padding: 8px 20px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .complete-btn-detail:hover {
      background-color: #2980b9;
    }
    /* å‚¬åŠæŒ‰é’®æ ·å¼ */
    .remind-btn {
      padding: 8px 20px;
      background-color: #e74c3c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .remind-btn:hover {
      background-color: #c0392b;
    }
    /* åˆ é™¤å¾…åŠæŒ‰é’®æ ·å¼ */
    .delete-todo-btn {
      padding: 8px 20px;
      background-color: #95a5a6;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .delete-todo-btn:hover {
      background-color: #7f8c8d;
    }
  </style>
</head>
<body>
  <!-- ç™»å½•é¡µé¢ -->
  <div class="login-container" id="loginPage">
    <h2 class="login-title">å¾…åŠäº‹é¡¹ç®¡ç†ç³»ç»Ÿ</h2>
    <div class="form-group">
      <label for="username">ç”¨æˆ·å</label>
      <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼ˆè¶…çº§ç®¡ç†å‘˜ï¼šadminï¼‰">
      <div class="error-msg" id="userError">ç”¨æˆ·åä¸èƒ½ä¸ºç©º</div>
    </div>
    <div class="form-group">
      <label for="password">å¯†ç </label>
      <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè¶…çº§ç®¡ç†å‘˜ï¼š123456ï¼‰">
      <div class="error-msg" id="pwdError">å¯†ç ä¸èƒ½ä¸ºç©º</div>
    </div>
    <button class="btn" id="loginBtn">ç™»å½•</button>
    <div class="login-tip">è¶…çº§ç®¡ç†å‘˜ï¼šadmin / 123456ï¼ˆä»…ç®¡ç†å‘˜å¯åˆ›å»ºè´¦å·ï¼‰</div>
  </div>

  <!-- ä¸»é¡µé¢ï¼ˆç™»å½•åæ˜¾ç¤ºï¼‰ -->
  <div class="main-container" id="mainPage">
    <div class="header">
      <h1 class="header-title">å¾…åŠäº‹é¡¹ç®¡ç†</h1>
      <div class="user-info">
        <span id="currentUser"></span>
        <button class="admin-btn" id="adminBtn" style="display: none;">è´¦å·ç®¡ç†</button>
        <button class="logout-btn" id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>

    <!-- åŠŸèƒ½åˆ‡æ¢æ ‡ç­¾ -->
    <div class="tab-container">
      <button class="tab-btn active" data-tab="create-todo">åˆ›å»ºå¾…åŠ</button>
      <button class="tab-btn" data-tab="my-todo">æˆ‘çš„å¾…åŠ</button>
    </div>

    <!-- åˆ›å»ºå¾…åŠå¡ç‰‡ -->
    <div class="card active" id="create-todo">
      <h2 class="card-title">æ–°å¢å¾…åŠäº‹é¡¹</h2>
      <form id="todoForm">
        <div class="form-group">
          <label for="title">å¾…åŠæ ‡é¢˜ <span style="color: red;">*</span></label>
          <input type="text" id="title" name="title" required placeholder="è¯·è¾“å…¥å¾…åŠæ ‡é¢˜ï¼ˆå¦‚ï¼šå®Œæˆé¡¹ç›®æŠ¥å‘Šï¼‰">
        </div>
        <div class="form-group">
          <label for="content">å¾…åŠè¯¦æƒ…</label>
          <textarea id="content" name="content" placeholder="è¯·è¾“å…¥å¾…åŠè¯¦ç»†å†…å®¹ï¼ˆé€‰å¡«ï¼‰"></textarea>
        </div>
        <div class="form-group">
          <label for="executor">æ‰§è¡Œäºº <span style="color: red;">*</span></label>
          <input type="text" id="executor" name="executor" required placeholder="è¯·è¾“å…¥æ‰§è¡Œäººå§“åï¼ˆéœ€ä¸ºç³»ç»Ÿå·²å­˜åœ¨è´¦å·ï¼‰">
        </div>
        <div class="form-group">
          <label for="deadline">æˆªæ­¢æ—¶é—´ <span style="color: #e74c3c;">ï¼ˆæé†’ä¾æ®ï¼‰</span></label>
          <input type="datetime-local" id="deadline" name="deadline">
        </div>
        <button type="submit" class="btn">æäº¤å¾…åŠ</button>
        <div id="message" class="message"></div>
      </form>
    </div>

    <!-- æˆ‘çš„å¾…åŠå¡ç‰‡ -->
    <div class="card" id="my-todo">
      <h2 class="card-title">æˆ‘çš„å¾…åŠäº‹é¡¹</h2>
      <div class="filter-btn-group">
        <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
        <button class="filter-btn" data-filter="pending">å¾…å¤„ç†</button>
        <button class="filter-btn" data-filter="completed">å·²å®Œæˆ</button>
      </div>
      <div id="todoList"></div>
    </div>
  </div>

  <!-- ç®¡ç†å‘˜è´¦å·ç®¡ç†å¼¹çª— -->
  <div class="admin-modal" id="adminModal">
    <div class="admin-modal-content">
      <span class="close-modal" id="closeModal">&times;</span>
      <h3 class="admin-modal-title">è´¦å·ç®¡ç†</h3>
      <div class="form-group">
        <label for="newUsername">æ–°å»ºç”¨æˆ·å</label>
        <input type="text" id="newUsername" placeholder="è¯·è¾“å…¥æ–°è´¦å·ç”¨æˆ·å">
      </div>
      <div class="form-group">
        <label for="newPassword">æ–°å»ºå¯†ç </label>
        <input type="password" id="newPassword" placeholder="è¯·è¾“å…¥æ–°è´¦å·å¯†ç ">
      </div>
      <div class="form-group">
        <label for="userRole">è´¦å·è§’è‰²</label>
        <select id="userRole" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd;">
          <option value="user">æ™®é€šç”¨æˆ·</option>
          <option value="admin">ç®¡ç†å‘˜</option>
        </select>
      </div>
      <button class="btn" id="createUserBtn">åˆ›å»ºè´¦å·</button>
      <h4 style="margin-top: 20px; color: #34495e;">ç°æœ‰è´¦å·åˆ—è¡¨</h4>
      <div class="user-list" id="userList"></div>
    </div>
  </div>

  <!-- å¾…åŠè¯¦æƒ…å¼¹çª— -->
  <div class="todo-detail-modal" id="todoDetailModal">
    <div class="todo-detail-content">
      <div class="detail-header">
        <div class="detail-title" id="detailTitle"></div>
        <span class="detail-close" id="detailClose">&times;</span>
      </div>
      <div class="detail-meta">
        <div class="meta-item"><span class="meta-label">åˆ›å»ºäººï¼š</span><span id="detailCreator"></span></div>
        <div class="meta-item"><span class="meta-label">æ‰§è¡Œäººï¼š</span><span id="detailExecutor"></span></div>
        <div class="meta-item"><span class="meta-label">åˆ›å»ºæ—¶é—´ï¼š</span><span id="detailCreateTime"></span></div>
        <div class="meta-item"><span class="meta-label">æˆªæ­¢æ—¶é—´ï¼š</span><span id="detailDeadline"></span></div>
        <div class="meta-item"><span class="meta-label">çŠ¶æ€ï¼š</span><span id="detailStatus"></span></div>
      </div>
      <div class="detail-content">
        <span class="content-label">å¾…åŠè¯¦æƒ…ï¼ˆå¯ç¼–è¾‘ï¼‰ï¼š</span>
        <textarea class="edit-content" id="editContent"></textarea>
      </div>
      <div class="upload-section">
        <span class="content-label">å›¾ç‰‡é™„ä»¶ï¼š</span>
        <label class="upload-btn">
          ä¸Šä¼ å›¾ç‰‡
          <input type="file" id="imageUpload" accept="image/*" multiple>
        </label>
        <div class="preview-container" id="imagePreview"></div>
      </div>
      <div class="detail-action">
        <button class="complete-btn-detail" id="detailCompleteBtn">æ ‡è®°ä¸ºå®Œæˆ</button>
        <button class="remind-btn" id="detailRemindBtn" style="display: none;">å‚¬åŠ</button>
        <button class="delete-todo-btn" id="detailDeleteBtn" style="display: none;">åˆ é™¤å¾…åŠ</button>
        <button class="save-btn" id="detailSaveBtn">ä¿å­˜ä¿®æ”¹</button>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let reminderTimer = null; // æé†’å®šæ—¶å™¨
    const CHECK_INTERVAL = 30 * 1000; // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡å¾…åŠ
    const REMIND_TIME = 15 * 60 * 1000; // æå‰15åˆ†é’Ÿæé†’
    let currentFilter = 'all'; // å½“å‰ç­›é€‰çŠ¶æ€
    let currentTodoId = null; // å½“å‰æŸ¥çœ‹çš„å¾…åŠID
    let currentTodoOwner = null; // å½“å‰å¾…åŠæ‰€å±ç”¨æˆ·
    let currentTodoCreator = null; // å½“å‰å¾…åŠåˆ›å»ºäºº
    let currentTodoExecutor = null; // å½“å‰å¾…åŠæ‰§è¡Œäºº

    // é¡µé¢åŠ è½½å®Œæˆåç«‹å³æ‰§è¡Œåˆå§‹åŒ–
    window.onload = function() {
      // åˆå§‹åŒ–ç”¨æˆ·æ•°æ®ï¼ˆé¢„è®¾è¶…çº§ç®¡ç†å‘˜ï¼‰
      initUserStorage();
      // è¯·æ±‚é€šçŸ¥æƒé™
      requestNotificationPermission();
      // ç«‹å³ç»‘å®šç™»å½•æŒ‰é’®äº‹ä»¶
      bindLoginBtnEvent();
      // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
      checkLoginStatus();
      // ç»‘å®šç®¡ç†å‘˜å¼¹çª—äº‹ä»¶
      bindAdminEvents();
      // ç»‘å®šæ ‡ç­¾åˆ‡æ¢äº‹ä»¶
      bindTabEvents();
      // ç»‘å®šç­›é€‰äº‹ä»¶
      bindFilterEvents();
      // ç»‘å®šè¯¦æƒ…å¼¹çª—äº‹ä»¶
      bindDetailEvents();
      // ç»‘å®šå›¾ç‰‡ä¸Šä¼ äº‹ä»¶
      bindImageUpload();
    };

    // åˆå§‹åŒ–ç”¨æˆ·å­˜å‚¨
    function initUserStorage() {
      try {
        const users = localStorage.getItem('todoUsers');
        if (!users) {
          // é¢„è®¾è¶…çº§ç®¡ç†å‘˜è´¦å·
          const defaultAdmin = {
            'admin': { 
              password: '123456', 
              todos: [],
              role: 'admin' // ç®¡ç†å‘˜è§’è‰²
            }
          };
          localStorage.setItem('todoUsers', JSON.stringify(defaultAdmin));
        }
      } catch (e) {
        alert('åˆå§‹åŒ–ç”¨æˆ·æ•°æ®å¤±è´¥ï¼š' + e.message);
      }
    }

    // è¯·æ±‚é€šçŸ¥æƒé™
    function requestNotificationPermission() {
      if (Notification && Notification.permission !== 'granted') {
        Notification.requestPermission();
      }
    }

    // ç»‘å®šç™»å½•æŒ‰é’®äº‹ä»¶
    function bindLoginBtnEvent() {
      const loginBtn = document.getElementById('loginBtn');
      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');
      const userError = document.getElementById('userError');
      const pwdError = document.getElementById('pwdError');

      // ç‚¹å‡»ç™»å½•æŒ‰é’®
      loginBtn.onclick = function() {
        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();
        let hasError = false;

        // æ¸…ç©ºä¹‹å‰çš„é”™è¯¯æç¤º
        userError.style.display = 'none';
        pwdError.style.display = 'none';

        // éªŒè¯è¾“å…¥
        if (!username) {
          userError.style.display = 'block';
          hasError = true;
        }

        if (!password) {
          pwdError.style.display = 'block';
          hasError = true;
        }

        if (hasError) return;

        try {
          // éªŒè¯è´¦å·
          const usersStr = localStorage.getItem('todoUsers');
          if (!usersStr) {
            alert('ç”¨æˆ·æ•°æ®ä¸å­˜åœ¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼');
            return;
          }
          
          const users = JSON.parse(usersStr);
          if (users[username]) {
            // è´¦å·å­˜åœ¨ï¼ŒéªŒè¯å¯†ç 
            if (users[username].password === password) {
              // ç™»å½•æˆåŠŸ
              loginSuccess(username);
            } else {
              alert('å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•ï¼');
            }
          } else {
            alert('è¯¥è´¦å·ä¸å­˜åœ¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜åˆ›å»ºï¼');
          }
        } catch (e) {
          alert('ç™»å½•éªŒè¯å¤±è´¥ï¼š' + e.message);
        }
      };

      // å›è½¦ç™»å½•
      passwordInput.onkeyup = function(e) {
        if (e.key === 'Enter' || e.keyCode === 13) {
          loginBtn.click();
        }
      };

      // å…¼å®¹ï¼šç”¨æˆ·åæ¡†å›è½¦ä¹Ÿè§¦å‘ç™»å½•
      usernameInput.onkeyup = function(e) {
        if (e.key === 'Enter' || e.keyCode === 13) {
          passwordInput.focus();
        }
      };
    }

    // ç™»å½•æˆåŠŸå¤„ç†
    function loginSuccess(username) {
      try {
        // è®°å½•ç™»å½•çŠ¶æ€
        localStorage.setItem('currentLoginUser', username);
        // è·å–ç”¨æˆ·ä¿¡æ¯
        const usersStr = localStorage.getItem('todoUsers');
        const users = JSON.parse(usersStr);
        const userInfo = users[username];
        
        // æ˜¾ç¤ºä¸»é¡µé¢ï¼Œéšè—ç™»å½•é¡µ
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('mainPage').style.display = 'block';
        
        // æ˜¾ç¤ºå½“å‰ç”¨æˆ·å’Œè§’è‰²
        const roleText = userInfo.role === 'admin' ? 'ï¼ˆç®¡ç†å‘˜ï¼‰' : 'ï¼ˆæ™®é€šç”¨æˆ·ï¼‰';
        document.getElementById('currentUser').textContent = `å½“å‰ç”¨æˆ·ï¼š${username} ${roleText}`;
        
        // ç®¡ç†å‘˜æ˜¾ç¤ºè´¦å·ç®¡ç†æŒ‰é’®
        if (userInfo.role === 'admin') {
          document.getElementById('adminBtn').style.display = 'block';
        } else {
          document.getElementById('adminBtn').style.display = 'none';
        }
        
        // åˆå§‹åŒ–ä¸»é¡µé¢
        initMainPage();
        // å¯åŠ¨å¾…åŠæé†’å®šæ—¶å™¨
        startReminderTimer();
        
        // ç™»å½•æˆåŠŸæç¤º
        alert('ç™»å½•æˆåŠŸï¼');
      } catch (e) {
        alert('ç™»å½•ååˆå§‹åŒ–å¤±è´¥ï¼š' + e.message);
      }
    }

    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    function checkLoginStatus() {
      try {
        const currentUser = localStorage.getItem('currentLoginUser');
        if (currentUser) {
          // å·²ç™»å½•ï¼Œç›´æ¥è¿›å…¥ä¸»é¡µé¢
          const usersStr = localStorage.getItem('todoUsers');
          const users = JSON.parse(usersStr);
          const userInfo = users[currentUser];
          
          document.getElementById('loginPage').style.display = 'none';
          document.getElementById('mainPage').style.display = 'block';
          
          const roleText = userInfo.role === 'admin' ? 'ï¼ˆç®¡ç†å‘˜ï¼‰' : 'ï¼ˆæ™®é€šç”¨æˆ·ï¼‰';
          document.getElementById('currentUser').textContent = `å½“å‰ç”¨æˆ·ï¼š${currentUser} ${roleText}`;
          
          if (userInfo.role === 'admin') {
            document.getElementById('adminBtn').style.display = 'block';
          }
          
          initMainPage();
          startReminderTimer();
        }
      } catch (e) {
        console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥ï¼š', e);
      }
    }

    // åˆå§‹åŒ–ä¸»é¡µé¢
    function initMainPage() {
      // ç»‘å®šè¡¨å•æäº¤
      bindTodoForm();
      // ç»‘å®šé€€å‡ºç™»å½•
      bindLogout();
      // æ¸²æŸ“å¾…åŠåˆ—è¡¨
      renderTodoList();
    }

    // ç»‘å®šæ ‡ç­¾åˆ‡æ¢äº‹ä»¶
    function bindTabEvents() {
      const tabBtns = document.querySelectorAll('.tab-btn');
      tabBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          // åˆ‡æ¢æ ‡ç­¾æ¿€æ´»çŠ¶æ€
          tabBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          // åˆ‡æ¢å¡ç‰‡æ˜¾ç¤º
          const tabId = this.getAttribute('data-tab');
          const cards = document.querySelectorAll('.card');
          cards.forEach(card => {
            card.classList.remove('active');
            if (card.id === tabId) {
              card.classList.add('active');
            }
          });
        });
      });
    }

    // ç»‘å®šç­›é€‰äº‹ä»¶
    function bindFilterEvents() {
      const filterBtns = document.querySelectorAll('.filter-btn');
      filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          // åˆ‡æ¢ç­›é€‰æŒ‰é’®æ¿€æ´»çŠ¶æ€
          filterBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          // æ›´æ–°å½“å‰ç­›é€‰çŠ¶æ€
          currentFilter = this.getAttribute('data-filter');
          
          // é‡æ–°æ¸²æŸ“åˆ—è¡¨
          renderTodoList();
        });
      });
    }

    // ç»‘å®šå¾…åŠè¡¨å•
    function bindTodoForm() {
      const form = document.getElementById('todoForm');
      const message = document.getElementById('message');

      form.addEventListener('submit', function(e) {
        e.preventDefault();
        const currentUser = localStorage.getItem('currentLoginUser');
        const usersStr = localStorage.getItem('todoUsers');
        const users = JSON.parse(usersStr);
        
        // è·å–è¡¨å•æ•°æ®
        const title = document.getElementById('title').value.trim();
        const content = document.getElementById('content').value.trim();
        const executor = document.getElementById('executor').value.trim();
        const deadline = document.getElementById('deadline').value;

        // éªŒè¯æ‰§è¡Œäººæ˜¯å¦å­˜åœ¨
        if (!users[executor]) {
          message.className = 'message error';
          message.textContent = `æ‰§è¡Œäºº${executor}ä¸å­˜åœ¨ï¼Œè¯·è¾“å…¥ç³»ç»Ÿå·²å­˜åœ¨çš„è´¦å·ï¼`;
          setTimeout(() => message.style.display = 'none', 3000);
          return;
        }

        // æ„é€ å¾…åŠæ•°æ®
        const todoData = {
          id: Date.now(),
          title: title,
          content: content,
          executor: executor, // æ‰§è¡Œäºº
          creator: currentUser, // åˆ›å»ºäºº
          deadline: deadline,
          status: 'pending',
          createTime: new Date().toLocaleString('zh-CN'),
          images: [], // å›¾ç‰‡é™„ä»¶
          remindCount: 0 // å‚¬åŠæ¬¡æ•°
        };

        // ä¿å­˜å¾…åŠï¼ˆå­˜å‚¨åœ¨åˆ›å»ºäººè´¦å·ä¸‹ï¼‰
        users[currentUser].todos = users[currentUser].todos || [];
        users[currentUser].todos.unshift(todoData);
        localStorage.setItem('todoUsers', JSON.stringify(users));

        // æç¤ºæˆåŠŸ
        message.className = 'message success';
        message.textContent = 'å¾…åŠäº‹é¡¹æ·»åŠ æˆåŠŸï¼å·²é€šçŸ¥æ‰§è¡Œäººï¼š' + executor;
        setTimeout(() => message.style.display = 'none', 3000);

        // é‡ç½®è¡¨å•
        form.reset();

        // å‘é€é€šçŸ¥ç»™æ‰§è¡Œäºº
        sendNotification('ğŸ“‹ æ–°çš„å¾…åŠäº‹é¡¹å·²åˆ†é…ç»™ä½ ', 
          `åˆ›å»ºäººï¼š${currentUser}\næ ‡é¢˜ï¼š${todoData.title}\nè¯·åŠæ—¶å¤„ç†`);

        // å¦‚æœå½“å‰åœ¨æˆ‘çš„å¾…åŠæ ‡ç­¾ä¸”æ˜¯ç®¡ç†å‘˜/æ‰§è¡Œäººæœ¬äººï¼Œé‡æ–°æ¸²æŸ“åˆ—è¡¨
        if (document.querySelector('.tab-btn.active').getAttribute('data-tab') === 'my-todo') {
          renderTodoList();
        }
      });
    }

    // ç»‘å®šé€€å‡ºç™»å½•
    function bindLogout() {
      const logoutBtn = document.getElementById('logoutBtn');
      logoutBtn.addEventListener('click', function() {
        if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
          // æ¸…é™¤ç™»å½•çŠ¶æ€
          localStorage.removeItem('currentLoginUser');
          // åœæ­¢å®šæ—¶å™¨
          stopReminderTimer();
          // è¿”å›ç™»å½•é¡µ
          document.getElementById('mainPage').style.display = 'none';
          document.getElementById('loginPage').style.display = 'block';
          // æ¸…ç©ºè¾“å…¥æ¡†
          document.getElementById('username').value = '';
          document.getElementById('password').value = '';
        }
      });
    }

    // ç»‘å®šç®¡ç†å‘˜å¼¹çª—äº‹ä»¶
    function bindAdminEvents() {
      const adminBtn = document.getElementById('adminBtn');
      const adminModal = document.getElementById('adminModal');
      const closeModal = document.getElementById('closeModal');
      const createUserBtn = document.getElementById('createUserBtn');

      // æ‰“å¼€ç®¡ç†å‘˜å¼¹çª—
      adminBtn.addEventListener('click', function() {
        adminModal.style.display = 'flex';
        // åŠ è½½ç°æœ‰è´¦å·åˆ—è¡¨
        loadUserList();
      });

      // å…³é—­ç®¡ç†å‘˜å¼¹çª—
      closeModal.addEventListener('click', function() {
        adminModal.style.display = 'none';
      });

      // ç‚¹å‡»å¼¹çª—å¤–åŒºåŸŸå…³é—­
      window.addEventListener('click', function(e) {
        if (e.target === adminModal) {
          adminModal.style.display = 'none';
        }
      });

      // åˆ›å»ºæ–°è´¦å·
      createUserBtn.addEventListener('click', function() {
        const newUsername = document.getElementById('newUsername').value.trim();
        const newPassword = document.getElementById('newPassword').value.trim();
        const userRole = document.getElementById('userRole').value;

        if (!newUsername || !newPassword) {
          alert('ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©ºï¼');
          return;
        }

        const usersStr = localStorage.getItem('todoUsers');
        const users = JSON.parse(usersStr);
        if (users[newUsername]) {
          alert('è¯¥ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·æ›´æ¢ï¼');
          return;
        }

        // åˆ›å»ºæ–°è´¦å·
        users[newUsername] = {
          password: newPassword,
          todos: [],
          role: userRole
        };
        localStorage.setItem('todoUsers', JSON.stringify(users));

        alert('è´¦å·åˆ›å»ºæˆåŠŸï¼');
        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('newUsername').value = '';
        document.getElementById('newPassword').value = '';
        // é‡æ–°åŠ è½½è´¦å·åˆ—è¡¨
        loadUserList();
      });
    }

    // åŠ è½½è´¦å·åˆ—è¡¨
    function loadUserList() {
      const usersStr = localStorage.getItem('todoUsers');
      const users = JSON.parse(usersStr);
      const userListEl = document.getElementById('userList');
      userListEl.innerHTML = '';

      for (const username in users) {
        const user = users[username];
        const roleClass = user.role === 'admin' ? 'role-admin' : 'role-user';
        const roleText = user.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·';

        const userItem = document.createElement('div');
        userItem.className = 'user-item';
        userItem.innerHTML = `
          <span>${username}</span>
          <span class="user-role ${roleClass}">${roleText}</span>
        `;
        userListEl.appendChild(userItem);
      }
    }

    // æ¸²æŸ“å¾…åŠåˆ—è¡¨
    function renderTodoList() {
      const currentUser = localStorage.getItem('currentLoginUser');
      const usersStr = localStorage.getItem('todoUsers');
      const users = JSON.parse(usersStr);
      const currentUserInfo = users[currentUser];
      
      // æ”¶é›†å¾…åŠæ•°æ®
      let allTodos = [];

      // 1. ç®¡ç†å‘˜èƒ½çœ‹åˆ°æ‰€æœ‰å¾…åŠ
      if (currentUserInfo.role === 'admin') {
        for (const username in users) {
          if (users[username].todos && users[username].todos.length > 0) {
            allTodos = allTodos.concat(users[username].todos);
          }
        }
      } 
      // 2. æ™®é€šç”¨æˆ·ä»…æ˜¾ç¤ºæ‰§è¡Œäººæ˜¯è‡ªå·±çš„å¾…åŠ
      else {
        for (const username in users) {
          if (users[username].todos && users[username].todos.length > 0) {
            const assignedToMe = users[username].todos.filter(todo => todo.executor === currentUser);
            allTodos = allTodos.concat(assignedToMe);
          }
        }
      }

      // å»é‡å¹¶æŒ‰åˆ›å»ºæ—¶é—´æ’åº
      const uniqueTodos = Array.from(new Map(allTodos.map(todo => [todo.id, todo])).values());
      uniqueTodos.sort((a, b) => b.id - a.id); // æœ€æ–°çš„åœ¨å‰

      // ç­›é€‰å¾…åŠ
      let filteredTodos = [];
      if (currentFilter === 'pending') {
        filteredTodos = uniqueTodos.filter(todo => todo.status === 'pending');
      } else if (currentFilter === 'completed') {
        filteredTodos = uniqueTodos.filter(todo => todo.status === 'completed');
      } else {
        filteredTodos = uniqueTodos;
      }

      const todoListEl = document.getElementById('todoList');
      if (filteredTodos.length === 0) {
        todoListEl.innerHTML = `<div class="empty-tip">æš‚æ— ${currentFilter === 'all' ? '' : currentFilter === 'pending' ? 'å¾…å¤„ç†' : 'å·²å®Œæˆ'}å¾…åŠäº‹é¡¹</div>`;
        return;
      }

      let listHtml = '';
      filteredTodos.forEach(todo => {
        const deadline = todo.deadline 
          ? new Date(todo.deadline).toLocaleString('zh-CN') 
          : 'æ— ';
        const statusClass = todo.status === 'pending' ? 'status-pending' : 'status-completed';
        const statusText = todo.status === 'pending' ? 'å¾…å¤„ç†' : 'å·²å®Œæˆ';

        // ç®€ç•¥å†…å®¹ï¼ˆè¶…å‡º50å­—çœç•¥ï¼‰
        const briefContent = todo.content ? todo.content.substring(0, 50) + (todo.content.length > 50 ? '...' : '') : 'æ— è¯¦ç»†å†…å®¹';

        listHtml += `
          <div class="todo-item" onclick="openTodoDetail(${todo.id})" data-id="${todo.id}">
            <div class="todo-header">
              <div class="todo-title">${todo.title}</div>
              <div class="todo-status ${statusClass}">${statusText}</div>
            </div>
            <div class="todo-meta">
              <span>åˆ›å»ºäººï¼š${todo.creator}</span>
              <span>åˆ›å»ºæ—¶é—´ï¼š${todo.createTime}</span>
              <span>æˆªæ­¢æ—¶é—´ï¼š${deadline}</span>
              ${todo.remindCount > 0 ? `<span style="color: #e74c3c;">å·²å‚¬åŠ${todo.remindCount}æ¬¡</span>` : ''}
            </div>
            <div class="todo-brief">${briefContent}</div>
          </div>
        `;
      });

      todoListEl.innerHTML = listHtml;
    }

    // æ‰“å¼€å¾…åŠè¯¦æƒ…å¼¹çª—
    function openTodoDetail(todoId) {
      const currentUser = localStorage.getItem('currentLoginUser');
      const usersStr = localStorage.getItem('todoUsers');
      const users = JSON.parse(usersStr);
      
      // æ‰¾åˆ°å¾…åŠæ‰€å±ç”¨æˆ·å’Œè¯¦æƒ…
      let todo = null;
      currentTodoOwner = null;
      currentTodoCreator = null;
      currentTodoExecutor = null;
      
      for (const username in users) {
        if (users[username].todos) {
          const foundTodo = users[username].todos.find(t => t.id === todoId);
          if (foundTodo) {
            todo = foundTodo;
            currentTodoOwner = username;
            currentTodoCreator = todo.creator;
            currentTodoExecutor = todo.executor;
            break;
          }
        }
      }

      if (!todo || !currentTodoOwner) {
        alert('å¾…åŠäº‹é¡¹ä¸å­˜åœ¨ï¼');
        return;
      }

      // ä¿å­˜å½“å‰å¾…åŠID
      currentTodoId = todoId;

      // å¡«å……è¯¦æƒ…æ•°æ®
      document.getElementById('detailTitle').textContent = todo.title;
      document.getElementById('detailCreator').textContent = todo.creator;
      document.getElementById('detailExecutor').textContent = todo.executor;
      document.getElementById('detailCreateTime').textContent = todo.createTime;
      document.getElementById('detailDeadline').textContent = todo.deadline ? new Date(todo.deadline).toLocaleString('zh-CN') : 'æ— ';
      document.getElementById('detailStatus').textContent = todo.status === 'pending' ? 'å¾…å¤„ç†' : 'å·²å®Œæˆ';
      document.getElementById('editContent').value = todo.content || '';

      // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆï¼ˆå¸¦åˆ é™¤æŒ‰é’®ï¼‰
      renderImagePreview(todo.images || []);

      // æ§åˆ¶æŒ‰é’®æ˜¾ç¤º/éšè—
      const remindBtn = document.getElementById('detailRemindBtn');
      const deleteBtn = document.getElementById('detailDeleteBtn');
      const completeBtn = document.getElementById('detailCompleteBtn');
      
      // åªæœ‰åˆ›å»ºäººèƒ½çœ‹åˆ°å‚¬åŠå’Œåˆ é™¤æŒ‰é’®
      if (currentUser === currentTodoCreator) {
        remindBtn.style.display = 'block';
        deleteBtn.style.display = 'block';
        // å·²å®Œæˆçš„å¾…åŠéšè—å‚¬åŠæŒ‰é’®
        if (todo.status === 'completed') {
          remindBtn.style.display = 'none';
        }
      } else {
        remindBtn.style.display = 'none';
        deleteBtn.style.display = 'none';
      }

      // æ§åˆ¶å®ŒæˆæŒ‰é’®çŠ¶æ€
      if (todo.status === 'completed') {
        completeBtn.disabled = true;
        completeBtn.textContent = 'å·²å®Œæˆ';
        completeBtn.style.backgroundColor = '#7f8c8d';
      } else {
        completeBtn.disabled = false;
        completeBtn.textContent = 'æ ‡è®°ä¸ºå®Œæˆ';
        completeBtn.style.backgroundColor = '#3498db';
      }

      // æ˜¾ç¤ºè¯¦æƒ…å¼¹çª—
      document.getElementById('todoDetailModal').style.display = 'flex';
    }

    // ç»‘å®šè¯¦æƒ…å¼¹çª—äº‹ä»¶
    function bindDetailEvents() {
      // å…³é—­å¼¹çª—
      document.getElementById('detailClose').addEventListener('click', function() {
        document.getElementById('todoDetailModal').style.display = 'none';
        currentTodoId = null;
        currentTodoOwner = null;
        currentTodoCreator = null;
        currentTodoExecutor = null;
      });

      // ç‚¹å‡»å¼¹çª—å¤–å…³é—­
      document.getElementById('todoDetailModal').addEventListener('click', function(e) {
        if (e.target === this) {
          this.style.display = 'none';
          currentTodoId = null;
          currentTodoOwner = null;
          currentTodoCreator = null;
          currentTodoExecutor = null;
        }
      });

      // æ ‡è®°ä¸ºå®Œæˆ
      document.getElementById('detailCompleteBtn').addEventListener('click', function() {
        if (!currentTodoId || !currentTodoOwner) return;
        
        const usersStr = localStorage.getItem('todoUsers');
        const users = JSON.parse(usersStr);
        const todoIndex = users[currentTodoOwner].todos.findIndex(t => t.id === currentTodoId);
        
        if (todoIndex !== -1) {
          users[currentTodoOwner].todos[todoIndex].status = 'completed';
          localStorage.setItem('todoUsers', JSON.stringify(users));
          
          // æ›´æ–°å¼¹çª—çŠ¶æ€
          document.getElementById('detailStatus').textContent = 'å·²å®Œæˆ';
          this.disabled = true;
          this.textContent = 'å·²å®Œæˆ';
          this.style.backgroundColor = '#7f8c8d';
          
          // éšè—å‚¬åŠæŒ‰é’®
          document.getElementById('detailRemindBtn').style.display = 'none';
          
          // å‘é€é€šçŸ¥
          sendNotification(
            'âœ… å¾…åŠäº‹é¡¹å·²å®Œæˆ',
            `æ ‡é¢˜ï¼š${users[currentTodoOwner].todos[todoIndex].title}\næ‰§è¡Œäººï¼š${users[currentTodoOwner].todos[todoIndex].executor}`
          );
          
          // é‡æ–°æ¸²æŸ“åˆ—è¡¨
          renderTodoList();
        }
      });

      // ä¿å­˜ä¿®æ”¹
      document.getElementById('detailSaveBtn').addEventListener('click', function() {
        if (!currentTodoId || !currentTodoOwner) return;
        
        const usersStr = localStorage.getItem('todoUsers');
        const users = JSON.parse(usersStr);
        const todoIndex = users[currentTodoOwner].todos.findIndex(t => t.id === currentTodoId);
        
        if (todoIndex !== -1) {
          // æ›´æ–°å†…å®¹
          users[currentTodoOwner].todos[todoIndex].content = document.getElementById('editContent').value;
          // ä¿å­˜ä¿®æ”¹
          localStorage.setItem('todoUsers', JSON.stringify(users));
          
          alert('å¾…åŠäº‹é¡¹ä¿®æ”¹ä¿å­˜æˆåŠŸï¼');
          // é‡æ–°æ¸²æŸ“åˆ—è¡¨å’Œå¼¹çª—å†…å®¹
          renderTodoList();
          document.getElementById('editContent').value = users[currentTodoOwner].todos[todoIndex].content;
        }
      });

      // å‚¬åŠæŒ‰é’®äº‹ä»¶
      document.getElementById('detailRemindBtn').addEventListener('click', function() {
        if (!currentTodoId || !currentTodoOwner || !currentTodoExecutor) return;
        
        // éªŒè¯æ‰§è¡Œäººæ˜¯å¦åœ¨çº¿ï¼ˆå½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦æ˜¯æ‰§è¡Œäººï¼‰
        const currentUser = localStorage.getItem('currentLoginUser');
        if (currentUser === currentTodoExecutor) {
          alert('ä¸èƒ½å‚¬åŠè‡ªå·±çš„å¾…åŠï¼');
          return;
        }

        // æ›´æ–°å‚¬åŠæ¬¡æ•°
        const usersStr = localStorage.getItem('todoUsers');
        const users = JSON.parse(usersStr);
        const todoIndex = users[currentTodoOwner].todos.findIndex(t => t.id === currentTodoId);
        
        if (todoIndex !== -1) {
          // å¢åŠ å‚¬åŠæ¬¡æ•°
          users[currentTodoOwner].todos[todoIndex].remindCount = (users[currentTodoOwner].todos[todoIndex].remindCount || 0) + 1;
          localStorage.setItem('todoUsers', JSON.stringify(users));
          
          // å‘é€å‚¬åŠé€šçŸ¥ç»™æ‰§è¡Œäººï¼ˆå¸¦ç¡®è®¤å¼¹çª—ï¼‰
          sendRemindNotification(
            currentTodoCreator,
            currentTodoExecutor,
            users[currentTodoOwner].todos[todoIndex].title,
            users[currentTodoOwner].todos[todoIndex].remindCount
          );
          
          // æç¤ºåˆ›å»ºäºº
          alert(`å·²å‘æ‰§è¡Œäºº${currentTodoExecutor}å‘é€å‚¬åŠé€šçŸ¥ï¼`);
          
          // é‡æ–°æ¸²æŸ“åˆ—è¡¨
          renderTodoList();
        }
      });

      // åˆ é™¤å¾…åŠæŒ‰é’®äº‹ä»¶
      document.getElementById('detailDeleteBtn').addEventListener('click', function() {
        if (!currentTodoId || !currentTodoOwner) return;
        
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥å¾…åŠäº‹é¡¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
          return;
        }

        // åˆ é™¤å¾…åŠ
        const usersStr = localStorage.getItem('todoUsers');
        const users = JSON.parse(usersStr);
        const todoIndex = users[currentTodoOwner].todos.findIndex(t => t.id === currentTodoId);
        
        if (todoIndex !== -1) {
          // åˆ é™¤å¾…åŠ
          users[currentTodoOwner].todos.splice(todoIndex, 1);
          localStorage.setItem('todoUsers', JSON.stringify(users));
          
          alert('å¾…åŠäº‹é¡¹åˆ é™¤æˆåŠŸï¼');
          
          // å…³é—­è¯¦æƒ…å¼¹çª—
          document.getElementById('todoDetailModal').style.display = 'none';
          
          // é‡æ–°æ¸²æŸ“åˆ—è¡¨
          renderTodoList();
          
          // é‡ç½®å…¨å±€å˜é‡
          currentTodoId = null;
          currentTodoOwner = null;
          currentTodoCreator = null;
          currentTodoExecutor = null;
        }
      });
    }

    // ç»‘å®šå›¾ç‰‡ä¸Šä¼ äº‹ä»¶
    function bindImageUpload() {
      const imageUpload = document.getElementById('imageUpload');
      imageUpload.addEventListener('change', function(e) {
        if (!currentTodoId || !currentTodoOwner) {
          alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¾…åŠäº‹é¡¹ï¼');
          this.value = '';
          return;
        }

        const files = e.target.files;
        if (!files || files.length === 0) return;

        const usersStr = localStorage.getItem('todoUsers');
        const users = JSON.parse(usersStr);
        const todoIndex = users[currentTodoOwner].todos.findIndex(t => t.id === currentTodoId);
        
        if (todoIndex === -1) return;

        // å¤„ç†æ¯ä¸ªä¸Šä¼ çš„å›¾ç‰‡
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          if (!file.type.startsWith('image/')) continue;

          const reader = new FileReader();
          reader.onload = function(event) {
            // å°†å›¾ç‰‡è½¬ä¸ºbase64å­˜å‚¨
            const base64 = event.target.result;
            users[currentTodoOwner].todos[todoIndex].images = users[currentTodoOwner].todos[todoIndex].images || [];
            users[currentTodoOwner].todos[todoIndex].images.push(base64);
            
            // ä¿å­˜å¹¶æ›´æ–°é¢„è§ˆ
            localStorage.setItem('todoUsers', JSON.stringify(users));
            renderImagePreview(users[currentTodoOwner].todos[todoIndex].images);
          };
          reader.readAsDataURL(file);
        }

        // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©å™¨
        this.value = '';
      });
    }

    // æ¸²æŸ“å›¾ç‰‡é¢„è§ˆï¼ˆå¸¦åˆ é™¤æŒ‰é’®ï¼‰
    function renderImagePreview(images) {
      const previewContainer = document.getElementById('imagePreview');
      previewContainer.innerHTML = '';

      if (!images || images.length === 0) {
        previewContainer.innerHTML = '<div style="color:#7f8c8d; font-size:13px;">æš‚æ— å›¾ç‰‡é™„ä»¶</div>';
        return;
      }

      images.forEach((imgBase64, index) => {
        // åˆ›å»ºå›¾ç‰‡åŒ…è£…å™¨
        const wrapper = document.createElement('div');
        wrapper.className = 'image-preview-wrapper';
        
        // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
        const imgEl = document.createElement('img');
        imgEl.src = imgBase64;
        imgEl.className = 'image-preview';
        imgEl.title = `å›¾ç‰‡${index + 1}`;
        
        // åˆ›å»ºåˆ é™¤æŒ‰é’®
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-img-btn';
        deleteBtn.innerHTML = 'Ã—';
        deleteBtn.onclick = function(e) {
          e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
          deleteImage(index);
        };
        
        // ç‚¹å‡»å›¾ç‰‡æŸ¥çœ‹å¤§å›¾
        imgEl.addEventListener('click', function() {
          const imgModal = document.createElement('div');
          imgModal.style.position = 'fixed';
          imgModal.style.top = '0';
          imgModal.style.left = '0';
          imgModal.style.width = '100%';
          imgModal.style.height = '100%';
          imgModal.style.backgroundColor = 'rgba(0,0,0,0.8)';
          imgModal.style.display = 'flex';
          imgModal.style.justifyContent = 'center';
          imgModal.style.alignItems = 'center';
          imgModal.style.zIndex = '10002';
          
          const bigImg = document.createElement('img');
          bigImg.src = imgBase64;
          bigImg.style.maxWidth = '90%';
          bigImg.style.maxHeight = '90%';
          
          imgModal.appendChild(bigImg);
          document.body.appendChild(imgModal);
          
          // ç‚¹å‡»å…³é—­
          imgModal.addEventListener('click', function() {
            document.body.removeChild(imgModal);
          });
        });
        
        // ç»„è£…å…ƒç´ 
        wrapper.appendChild(imgEl);
        wrapper.appendChild(deleteBtn);
        previewContainer.appendChild(wrapper);
      });
    }

    // åˆ é™¤å›¾ç‰‡
    function deleteImage(index) {
      if (!currentTodoId || !currentTodoOwner) return;
      
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) {
        return;
      }

      const usersStr = localStorage.getItem('todoUsers');
      const users = JSON.parse(usersStr);
      const todoIndex = users[currentTodoOwner].todos.findIndex(t => t.id === currentTodoId);
      
      if (todoIndex !== -1) {
        // åˆ é™¤æŒ‡å®šç´¢å¼•çš„å›¾ç‰‡
        users[currentTodoOwner].todos[todoIndex].images = users[currentTodoOwner].todos[todoIndex].images || [];
        users[currentTodoOwner].todos[todoIndex].images.splice(index, 1);
        
        // ä¿å­˜ä¿®æ”¹
        localStorage.setItem('todoUsers', JSON.stringify(users));
        
        // é‡æ–°æ¸²æŸ“å›¾ç‰‡é¢„è§ˆ
        renderImagePreview(users[currentTodoOwner].todos[todoIndex].images);
        
        alert('å›¾ç‰‡åˆ é™¤æˆåŠŸï¼');
      }
    }

    // å‘é€å‚¬åŠé€šçŸ¥ï¼ˆå¸¦ç¡®è®¤å¼¹çª—ï¼‰
    function sendRemindNotification(creator, executor, title, remindCount) {
      // 1. æ¡Œé¢é€šçŸ¥
      if (Notification && Notification.permission === 'granted') {
        new Notification('ğŸ”” å¾…åŠäº‹é¡¹å‚¬åŠæé†’', {
          body: `åˆ›å»ºäººï¼š${creator}\nå¾…åŠæ ‡é¢˜ï¼š${title}\nè¿™æ˜¯ç¬¬${remindCount}æ¬¡å‚¬åŠ\nè¯·å°½å¿«å¤„ç†ï¼`,
          icon: 'https://cdn-icons-png.flaticon.com/512/179/179342.png',
          requireInteraction: true
        });
      }

      // 2. åˆ›å»ºå¸¦ç¡®è®¤çš„å‚¬åŠå¼¹çª—
      createRemindConfirmModal(creator, title, remindCount);
    }

    // åˆ›å»ºå¸¦ç¡®è®¤çš„å‚¬åŠå¼¹çª—
    function createRemindConfirmModal(creator, title, remindCount) {
      // å…ˆç§»é™¤å·²å­˜åœ¨çš„å‚¬åŠå¼¹çª—
      const oldModal = document.querySelector('.remind-modal');
      if (oldModal) oldModal.remove();

      // åˆ›å»ºæ–°å¼¹çª—
      const modal = document.createElement('div');
      modal.className = 'remind-modal';
      modal.innerHTML = `
        <div class="remind-header">ğŸ”” å¾…åŠäº‹é¡¹å‚¬åŠæé†’</div>
        <div class="remind-content">
          <p>åˆ›å»ºäººï¼š<strong>${creator}</strong></p>
          <p>å¾…åŠæ ‡é¢˜ï¼š<strong>${title}</strong></p>
          <p>è¿™æ˜¯ç¬¬<strong>${remindCount}</strong>æ¬¡å‚¬åŠï¼Œè¯·å°½å¿«å¤„ç†ï¼</p>
        </div>
        <button class="remind-confirm" onclick="this.parentElement.remove()">ç¡®è®¤æ”¶åˆ°</button>
      `;
      document.body.appendChild(modal);
    }

    // å‘é€æ™®é€šé€šçŸ¥
    function sendNotification(title, body) {
      // 1. æ¡Œé¢é€šçŸ¥
      if (Notification && Notification.permission === 'granted') {
        new Notification(title, {
          body: body,
          icon: 'https://cdn-icons-png.flaticon.com/512/179/179342.png',
          requireInteraction: true
        });
      }

      // 2. é¡µé¢å†…æé†’å¼¹çª—
      createReminderModal(title, body);
    }

    // åˆ›å»ºæ™®é€šæé†’å¼¹çª—
    function createReminderModal(title, content) {
      // å…ˆç§»é™¤å·²å­˜åœ¨çš„å¼¹çª—
      const oldModal = document.querySelector('.reminder-modal');
      if (oldModal) oldModal.remove();

      // åˆ›å»ºæ–°å¼¹çª—
      const modal = document.createElement('div');
      modal.className = 'reminder-modal';
      modal.innerHTML = `
        <div class="reminder-header">
          <div class="reminder-title">${title}</div>
          <span class="reminder-close" onclick="this.parentElement.parentElement.remove()">&times;</span>
        </div>
        <div class="reminder-content">${content.replace(/\n/g, '<br>')}</div>
      `;
      document.body.appendChild(modal);

      // 5ç§’åè‡ªåŠ¨å…³é—­
      setTimeout(() => {
        if (modal) modal.remove();
      }, 5000);
    }

    // å¯åŠ¨æé†’å®šæ—¶å™¨
    function startReminderTimer() {
      // å…ˆåœæ­¢å·²æœ‰å®šæ—¶å™¨
      stopReminderTimer();
      // ç«‹å³æ£€æŸ¥ä¸€æ¬¡
      checkReminderTodos();
      // è®¾ç½®å®šæ—¶æ£€æŸ¥
      reminderTimer = setInterval(checkReminderTodos, CHECK_INTERVAL);
    }

    // åœæ­¢æé†’å®šæ—¶å™¨
    function stopReminderTimer() {
      if (reminderTimer) {
        clearInterval(reminderTimer);
        reminderTimer = null;
      }
    }

    // æ£€æŸ¥éœ€è¦æé†’çš„å¾…åŠ
    function checkReminderTodos() {
      const currentUser = localStorage.getItem('currentLoginUser');
      if (!currentUser) return;

      const usersStr = localStorage.getItem('todoUsers');
      const users = JSON.parse(usersStr);
      const currentUserInfo = users[currentUser];
      
      // æ”¶é›†æ‰€æœ‰éœ€è¦æé†’çš„å¾…åŠ
      let reminderTodos = [];

      // ç®¡ç†å‘˜æ£€æŸ¥æ‰€æœ‰å¾…åŠ
      if (currentUserInfo.role === 'admin') {
        for (const username in users) {
          if (users[username].todos) {
            reminderTodos = reminderTodos.concat(users[username].todos);
          }
        }
      } 
      // æ™®é€šç”¨æˆ·åªæ£€æŸ¥æ‰§è¡Œäººæ˜¯è‡ªå·±çš„å¾…åŠ
      else {
        for (const username in users) {
          if (users[username].todos) {
            const assignedToMe = users[username].todos.filter(todo => todo.executor === currentUser && todo.status === 'pending');
            reminderTodos = reminderTodos.concat(assignedToMe);
          }
        }
      }

      // å»é‡
      const uniqueTodos = Array.from(new Map(reminderTodos.map(todo => [todo.id, todo])).values());
      const now = new Date().getTime();

      uniqueTodos.forEach(todo => {
        // åªæ£€æŸ¥å¾…å¤„ç†ä¸”æœ‰æˆªæ­¢æ—¶é—´çš„å¾…åŠ
        if (todo.status === 'pending' && todo.deadline) {
          const deadline = new Date(todo.deadline).getTime();
          const timeDiff = deadline - now;

          // æˆªæ­¢æ—¶é—´åœ¨15åˆ†é’Ÿå†… æˆ– å·²è¶…æ—¶ï¼Œè§¦å‘æé†’
          if (timeDiff > 0 && timeDiff <= REMIND_TIME) {
            sendNotification(
              'â° å¾…åŠäº‹é¡¹å³å°†åˆ°æœŸ',
              `æ ‡é¢˜ï¼š${todo.title}\nåˆ›å»ºäººï¼š${todo.creator}\nå‰©ä½™æ—¶é—´ï¼š${Math.ceil(timeDiff/60000)}åˆ†é’Ÿ`
            );
          } else if (timeDiff <= 0) {
            sendNotification(
              'âš ï¸ å¾…åŠäº‹é¡¹å·²è¶…æ—¶',
              `æ ‡é¢˜ï¼š${todo.title}\nåˆ›å»ºäººï¼š${todo.creator}\nå·²è¶…æ—¶ï¼š${Math.ceil(Math.abs(timeDiff)/60000)}åˆ†é’Ÿ`
            );
          }
        }
      });
    }

    // é¡µé¢å…³é—­æ—¶æ¸…ç†å®šæ—¶å™¨
    window.addEventListener('beforeunload', function() {
      stopReminderTimer();
    });
  </script>
</body>
</html>